function startpreview(e){let t=1;window.gamesettings&&(t=window.gamesettings.mastervolume/100*(window.gamesettings.musicvolume/100),t=Math.min(1,Math.max(0,t)));for(let e of document.getElementsByTagName("audio"))e.softstop&&e.softstop();const n=document.createElement("audio"),o=document.createElement("source");console.log("pazinga"),o.src=getPreviewUrl(e.sid),o.type="audio/mpeg",n.appendChild(o),n.volume=0,n.play(),document.body.appendChild(n);const a=setInterval(()=>{n.volume<t?n.volume=Math.min(t,n.volume+.05*t):clearInterval(a)},30),s=setInterval(()=>{n.currentTime>9.3&&(n.volume=Math.max(0,n.volume-.05*t)),0===n.volume&&(clearInterval(s),n.remove())},30);return n.softstop=function(){const e=setInterval(()=>{n.volume=Math.max(0,n.volume-.05*t),0===n.volume&&(clearInterval(e),n.remove())},10)},n}function startdownload(e){let t=startpreview(e);if(e.downloading)return;const n=getDownloadUrl(e.sid);e.downloading=!0,e.classList.add("downloading");const o=document.createElement("div");o.className="download-progress";const a=document.createElement("div");a.className="title",a.innerText=e.setdata.title;const s=document.createElement("progress");s.max=1,s.value=0,o.appendChild(a),o.appendChild(s);const l=document.getElementById("statuslines");l?l.insertBefore(o,l.children[3]):console.error("statuslines element not found"),e.download_starttime=(new Date).getTime(),fetch(n).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=e.headers.get("content-length");if(!t)throw new Error("Content-Length header is missing");const n=parseInt(t,10);let o=0;s.max=n;const a=e.body.getReader(),l=[];return function e(){return a.read().then(({done:t,value:n})=>{if(!t)return o+=n.length,s.value=o,l.push(n),e()})}().then(()=>new Blob(l))}).then(n=>{e.oszblob=n,s.className="finished",e.classList.remove("downloading"),t.softstop()}).catch(t=>{console.error("Download failed:",t.message),alert("Beatmap download failed. Please retry later."),e.downloading=!1,e.classList.remove("downloading")})}